# 大模型MCP工具调用工作流程

## 概述

本文档详细说明了大模型如何调用MCP服务器处理原始JSON数据，丰富内容，生成格式美观的Word文档，并提供公网下载链接的完整工作流程。

## 工作流程图

```
┌─────────────────┐     ┌──────────────────┐     ┌───────────────────┐     ┌──────────────────┐
│                 │     │                  │     │                   │     │                  │
│  原始JSON数据   │────>│  联网搜索MCP     │────>│  内容丰富JSON数据  │────>│  Word文档MCP    │
│                 │     │  (外部服务)      │     │                   │     │                  │
└─────────────────┘     └──────────────────┘     └───────────────────┘     └──────────────────┘
                                                                                   │
                                                                                   │
                                                                                   ▼
┌─────────────────┐     ┌──────────────────┐     ┌───────────────────┐     ┌──────────────────┐
│                 │     │                  │     │                   │     │                  │
│  公网下载链接   │<────│  服务器上传      │<────│  格式优美的Word   │<────│  Word文档生成   │
│                 │     │                  │     │                   │     │                  │
└─────────────────┘     └──────────────────┘     └───────────────────┘     └──────────────────┘
```

## 详细步骤

### 1. 接收原始JSON数据

大模型接收用户提供的原始JSON数据，这些数据包含基本的结构化内容：

```json
{
    "title": "报告标题",
    "author": "作者名",
    "headings": [
        {"text": "第一章", "level": 1},
        {"text": "第一节", "level": 2}
    ],
    "paragraphs": ["段落1内容", "段落2内容"],
    "tables": [
        {"data": [["表头1", "表头2"], ["数据1", "数据2"]]}
    ]
}
```

### 2. 调用联网搜索MCP

大模型识别JSON中的关键主题，然后调用**外部联网搜索MCP**获取最新相关资料：

1. **识别关键主题**：分析JSON中的标题、段落等内容，提取关键词
2. **构造搜索查询**：基于关键词构造有效的搜索查询
3. **调用外部MCP**：使用专门的联网搜索MCP获取最新信息
4. **处理搜索结果**：分析、筛选和组织搜索返回的信息

> 注意：联网搜索功能由外部MCP服务负责实现，本文档不详细描述其实现细节

### 3. 整合搜索结果到JSON

大模型将联网搜索获取的信息智能整合到原始JSON中：

1. **内容分类**：将搜索结果按主题分类
2. **结构化整理**：将搜索内容转换为JSON结构（标题、段落、表格等）
3. **内容丰富**：添加新的段落、标题、数据到原始JSON中
4. **数据验证**：确保整合后的JSON结构正确、完整

丰富后的JSON示例：

```json
{
    "title": "市场分析报告",
    "author": "张三",
    "headings": [
        {"text": "市场概况", "level": 1},
        {"text": "行业趋势", "level": 2},
        {"text": "最新市场数据", "level": 2},  // 新增标题
        {"text": "未来展望", "level": 1}       // 新增标题
    ],
    "paragraphs": [
        "这是原始的市场分析...",
        "根据最新数据显示，该行业增长率达到15%...",  // 新增内容
        "专家预测未来五年将保持稳定增长..."          // 新增内容
    ],
    "tables": [
        {"data": [["指标", "数值"], ["市场规模", "1000亿"]]},
        {"data": [["年份", "增长率"], ["2023", "15%"], ["2024", "17%"]]}  // 新增表格
    ]
}
```

### 4. 调用Word文档MCP服务器

大模型使用`auto_generate_and_upload_word`工具处理丰富后的JSON数据：

```python
result = await auto_generate_and_upload_word(
    filename="market_report.docx",
    content=enriched_content  # 丰富后的JSON数据
)
```

### 5. Word文档生成处理流程

`auto_generate_and_upload_word`工具内部执行以下优化处理：

1. **内存中创建文档**：避免频繁磁盘I/O
2. **批量添加内容**：
   - 添加标题和作者信息
   - 批量处理所有标题
   - 批量处理所有段落
   - 批量处理所有表格
   - 批量处理所有图片
   - 添加分页符（如有）
3. **应用样式和格式**：确保文档美观专业
4. **一次性保存文档**：减少磁盘I/O操作
5. **自动上传到服务器**：通过SFTP上传到配置的服务器
6. **生成公网下载链接**：创建可访问的URL

### 6. 返回公网下载链接

大模型接收并解析处理结果，获取公网下载链接：

```python
public_url = result["public_url"]  # 例如: http://8.156.74.79:8001/market_report.docx
```

## 错误处理与恢复

1. **JSON格式错误**：验证JSON结构，修复格式问题
2. **内容处理失败**：记录错误信息，尝试继续处理其他内容
3. **上传失败**：重试上传，提供详细错误信息
4. **链接生成失败**：检查服务器配置，尝试备用链接方式

## 性能优化亮点

1. **内存批处理**：所有内容在内存中处理，避免频繁I/O
2. **单次保存**：所有更改一次性保存，提高性能
3. **大数据支持**：优化算法支持数万条记录、数百个表格、大量图片
4. **资源管理**：自动清理临时资源，避免内存溢出
5. **并发处理**：支持异步操作，提高响应速度

## 服务器配置

Word文档上传服务器信息：
- 服务器地址: 8.156.74.79
- 端口: 8001 (HTTP服务)
- 远程目录: /root/files
- 公网访问格式: http://8.156.74.79:8001/文件名

## 示例调用

```python
# 原始JSON数据
original_data = {
    "title": "季度财务报告",
    "author": "财务部",
    "headings": [
        {"text": "收入分析", "level": 1},
        {"text": "支出分析", "level": 1}
    ],
    "paragraphs": [
        "本季度收入较上季度增长10%。",
        "主要支出集中在研发和市场营销领域。"
    ],
    "tables": [
        {"data": [["部门", "收入(万元)"], ["销售", "500"], ["服务", "300"]]}
    ]
}

# 联网搜索获取最新数据 (由外部MCP实现)
# ...搜索处理逻辑...

# 整合丰富后的JSON数据
enriched_data = original_data.copy()
enriched_data["headings"].append({"text": "行业对比分析", "level": 1})
enriched_data["paragraphs"].append("与行业平均水平相比，我们的利润率高出15%。")
enriched_data["tables"].append({
    "data": [["公司", "利润率"], ["我司", "35%"], ["行业平均", "20%"]]
})

# 调用文档生成与上传
result = await auto_generate_and_upload_word("financial_report.docx", enriched_data)

# 获取下载链接
public_url = result["public_url"]
```

## 总结

本工作流程充分利用了大模型的内容理解和生成能力，结合专业MCP服务的文档处理能力，实现了从原始JSON数据到格式美观的Word文档的自动化处理。通过联网搜索丰富内容，通过优化的文档处理提升性能，最终生成高质量文档并提供便捷的公网访问方式。 